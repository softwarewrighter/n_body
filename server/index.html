<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Body Galaxy Collision Simulation (Server-Powered)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
        }
        
        #canvas {
            display: block;
            cursor: grab;
        }
        
        #canvas:active {
            cursor: grabbing;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            min-width: 300px;
        }
        
        #controls h2 {
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaa;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        
        .control-group input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
        }
        
        .control-group button {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .control-group button:hover {
            background: #45a049;
        }
        
        .control-group button:active {
            background: #3d8b40;
        }
        
        #stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .stat-line {
            margin-bottom: 5px;
        }
        
        .value {
            color: #4CAF50;
            font-weight: bold;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #4CAF50;
        }
        
        #connection-status {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            font-size: 14px;
        }
        
        .connected {
            color: #4CAF50;
        }
        
        .disconnected {
            color: #f44336;
        }
        
        .server-indicator {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="connection-status" class="disconnected">
        Connecting to server...
        <div class="server-indicator">Server: <span id="serverUrl"></span></div>
    </div>
    
    <div id="controls">
        <h2>Galaxy Collision Controls</h2>
        <div class="server-indicator">Computation: Server-side (72 threads)</div>
        
        <div class="control-group">
            <label for="particleCount">Particles: <span id="particleCountValue">10000</span></label>
            <input type="range" id="particleCount" min="1000" max="1000000" value="10000" step="1000">
        </div>
        
        <div class="control-group">
            <label for="timeStep">Time Step: <span id="timeStepValue">0.01</span></label>
            <input type="range" id="timeStep" min="0.001" max="0.1" value="0.01" step="0.001">
        </div>
        
        <div class="control-group">
            <label for="gravity">Gravity Strength: <span id="gravityValue">1.0</span></label>
            <input type="range" id="gravity" min="0.1" max="5.0" value="1.0" step="0.1">
        </div>
        
        <div class="control-group">
            <button id="resetBtn">Reset Simulation</button>
        </div>
        
        <div class="control-group">
            <button id="pauseBtn">Pause</button>
        </div>
    </div>
    
    <div id="stats">
        <div class="stat-line">Server FPS: <span class="value" id="fps">0</span></div>
        <div class="stat-line">Compute Time: <span class="value" id="computeTime">0</span>ms</div>
        <div class="stat-line">Particles: <span class="value" id="activeParticles">0</span></div>
        <div class="stat-line">Sim Time: <span class="value" id="simTime">0.0</span>s</div>
        <div class="stat-line">CPU Usage: <span class="value" id="cpuUsage">0</span>%</div>
    </div>
    
    <div id="loading">Loading WASM...</div>
    
    <script type="module">
        import init, { Client } from './pkg/n_body_client.js';
        
        let client = null;
        let isPaused = false;
        
        // Global function for WebSocket message handling
        window.handleWebSocketMessage = function(message) {
            if (client) {
                client.handle_message(message);
            }
        };
        
        // Global function for stats updates
        window.updateStats = function(statsJson) {
            const stats = JSON.parse(statsJson);
            document.getElementById('fps').textContent = stats.fps.toFixed(1);
            document.getElementById('computeTime').textContent = stats.computation_time_ms.toFixed(2);
            document.getElementById('activeParticles').textContent = stats.particle_count;
            document.getElementById('simTime').textContent = stats.sim_time.toFixed(1);
            document.getElementById('cpuUsage').textContent = stats.cpu_usage.toFixed(1);
        };
        
        // Global function for connection status updates
        window.updateConnectionStatus = function(connected) {
            const status = document.getElementById('connection-status');
            const serverUrl = document.getElementById('serverUrl')?.textContent || 'ws://localhost:8080/ws';
            if (connected) {
                status.className = 'connected';
                status.innerHTML = 'Connected to server<div class="server-indicator">Server: ' + serverUrl + '</div>';
            } else {
                status.className = 'disconnected';
                status.innerHTML = 'Disconnected from server - Reconnecting in 3s...<div class="server-indicator">Server: ' + serverUrl + '</div>';
                
                // Auto-reconnect after 3 seconds
                setTimeout(() => {
                    console.log('Attempting to reconnect...');
                    window.location.reload();
                }, 3000);
            }
        };
        
        async function run() {
            await init();
            
            const loading = document.getElementById('loading');
            loading.classList.add('hidden');
            
            const canvas = document.getElementById('canvas');
            
            // Determine WebSocket URL from current page
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname || 'localhost';
            const port = window.location.port || '4000';
            const serverUrl = `${protocol}//${host}:${port}/ws`;
            
            document.getElementById('serverUrl').textContent = serverUrl;
            
            // Create client
            client = new Client(canvas, serverUrl);
            
            // Start client (WebSocket handlers are set up internally)
            client.start();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                client.resize();
            });
            
            // Control handlers
            document.getElementById('particleCount').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                document.getElementById('particleCountValue').textContent = value;
                client.set_particle_count(value);
            });
            
            document.getElementById('timeStep').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('timeStepValue').textContent = value.toFixed(3);
                client.set_time_step(value);
            });
            
            document.getElementById('gravity').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('gravityValue').textContent = value.toFixed(1);
                client.set_gravity_strength(value);
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                client.reset();
            });
            
            document.getElementById('pauseBtn').addEventListener('click', (e) => {
                if (isPaused) {
                    client.resume();
                    e.target.textContent = 'Pause';
                } else {
                    client.pause();
                    e.target.textContent = 'Resume';
                }
                isPaused = !isPaused;
            });
        }
        
        run();
    </script>
</body>
</html>