<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Body Galaxy Collision Simulation (Server-Powered)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
        }
        
        #canvas {
            display: block;
            cursor: grab;
        }
        
        #canvas:active {
            cursor: grabbing;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            min-width: 300px;
        }
        
        #controls h2 {
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaa;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        
        .control-group input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
        }
        
        .control-group button {
            flex: 1;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .control-group button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .control-group button:active {
            background: #3d8b40;
            transform: translateY(0);
        }
        
        .control-group button.paused {
            background: #ff9800;
        }
        
        .control-group button.paused:hover {
            background: #f57c00;
        }
        
        .control-group button.working {
            background: #757575;
            cursor: not-allowed;
            animation: pulse 1s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        .slider-hints {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        .help-text {
            font-size: 11px;
            color: #888;
            margin-top: 3px;
            font-style: italic;
        }
        
        #stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .stat-line {
            margin-bottom: 5px;
        }
        
        .value {
            color: #4CAF50;
            font-weight: bold;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #4CAF50;
        }
        
        #connection-status {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            font-size: 14px;
        }
        
        .connected {
            color: #4CAF50;
        }
        
        .disconnected {
            color: #f44336;
        }
        
        .server-indicator {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="connection-status" class="disconnected">
        Connecting to server...
        <div class="server-indicator">Server: <span id="serverUrl"></span></div>
    </div>
    
    <div id="controls">
        <h2>Galaxy Collision Controls</h2>
        <div class="server-indicator">Computation: Server-side (72 threads)</div>
        
        <div class="control-group">
            <label for="particleCount">Particles: <span id="particleCountValue">3000</span></label>
            <input type="range" id="particleCount" min="0" max="100" value="50" step="1">
            <div class="slider-hints">
                <span>1K</span>
                <span>10K</span>
                <span>100K</span>
                <span>1M</span>
            </div>
            <div class="help-text">Auto-restarts simulation when changed</div>
        </div>
        
        <div class="control-group">
            <label for="timeStep">Time Step: <span id="timeStepValue">0.01</span></label>
            <input type="range" id="timeStep" min="0.005" max="0.05" value="0.01" step="0.005">
            <div class="help-text">Physics simulation speed</div>
        </div>
        
        <div class="control-group">
            <label for="visualFPS">Visual FPS: <span id="visualFPSValue">30</span></label>
            <input type="range" id="visualFPS" min="10" max="60" value="30" step="5">
            <div class="help-text">Rendering speed (independent of physics)</div>
        </div>
        
        <div class="control-group">
            <label for="zoom">Zoom: <span id="zoomValue">1.0x</span></label>
            <input type="range" id="zoom" min="0.1" max="5.0" value="1.0" step="0.1">
            <div class="help-text">Camera view scale</div>
        </div>
        
        <div class="control-group">
            <label for="gravity">Gravity Strength: <span id="gravityValue">1.0</span></label>
            <input type="range" id="gravity" min="0.1" max="5.0" value="1.0" step="0.1">
            <div class="help-text">Gravitational force multiplier</div>
        </div>
        
        <div class="control-group button-row">
            <button id="pauseBtn">Pause</button>
            <button id="resetBtn">Reset</button>
        </div>
        
        <div class="control-group">
            <button id="resetCameraBtn">Reset Camera</button>
            <div class="help-text">Use ↑↓←→ arrow keys to move camera view</div>
        </div>
    </div>
    
    <div id="stats">
        <div class="stat-line">Server FPS: <span class="value" id="fps">0</span></div>
        <div class="stat-line">Compute Time: <span class="value" id="computeTime">0</span>ms</div>
        <div class="stat-line">Particles: <span class="value" id="activeParticles">0</span></div>
        <div class="stat-line">Sim Time: <span class="value" id="simTime">0.0</span>s</div>
        <div class="stat-line">CPU Usage: <span class="value" id="cpuUsage">0</span>%</div>
    </div>
    
    <div id="loading">Loading WASM...</div>
    
    <script type="module">
        import init, { Client } from './pkg/n_body_client.js';
        
        let client = null;
        let isPaused = false;
        let isConnected = false;
        let configUpdateTimeout = null;
        
        // Global function for WebSocket message handling
        window.handleWebSocketMessage = function(message) {
            if (client) {
                client.handle_message(message);
            }
        };
        
        // Global function for stats updates
        window.updateStats = function(statsJson) {
            const stats = JSON.parse(statsJson);
            document.getElementById('fps').textContent = stats.fps.toFixed(1);
            document.getElementById('computeTime').textContent = stats.computation_time_ms.toFixed(2);
            document.getElementById('activeParticles').textContent = stats.particle_count;
            document.getElementById('simTime').textContent = stats.sim_time.toFixed(1);
            document.getElementById('cpuUsage').textContent = stats.cpu_usage.toFixed(1);
        };
        
        // Global function for UI updates from server config
        window.updateUIFromConfig = function(configJson) {
            const config = JSON.parse(configJson);
            console.log('Updating UI with config:', config);
            
            // Enable debug mode if requested
            if (config.debug) {
                console.log('Debug mode enabled - verbose JavaScript logging active');
                window.N_BODY_DEBUG = true;
                // Add debug indicator to UI
                const debugIndicator = document.getElementById('debug-indicator');
                if (!debugIndicator) {
                    const indicator = document.createElement('div');
                    indicator.id = 'debug-indicator';
                    indicator.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #ff0; color: #000; padding: 5px 10px; font-weight: bold; z-index: 1000;';
                    indicator.textContent = 'DEBUG MODE';
                    document.body.appendChild(indicator);
                }
            }
            
            // Update particle count slider and display (using logarithmic scale)
            const sliderValue = particleCountToSlider(config.particle_count);
            document.getElementById('particleCount').value = sliderValue;
            document.getElementById('particleCountValue').textContent = config.particle_count.toLocaleString();
            
            // Update time step slider and display
            document.getElementById('timeStep').value = config.time_step;
            document.getElementById('timeStepValue').textContent = config.time_step.toFixed(3);
            
            // Update gravity strength slider and display
            document.getElementById('gravity').value = config.gravity_strength;
            document.getElementById('gravityValue').textContent = config.gravity_strength.toFixed(1);
            
            // Update visual FPS slider and display
            document.getElementById('visualFPS').value = config.visual_fps;
            document.getElementById('visualFPSValue').textContent = config.visual_fps;
            
            // Update zoom slider and display
            document.getElementById('zoom').value = config.zoom_level;
            document.getElementById('zoomValue').textContent = config.zoom_level.toFixed(1) + 'x';
            
            // Reset button states if they were working
            setButtonWorking('resetBtn', false);
            setButtonWorking('pauseBtn', false);
        };
        
        // Global function for connection status updates
        window.updateConnectionStatus = function(connected) {
            isConnected = connected;
            const status = document.getElementById('connection-status');
            const serverUrl = document.getElementById('serverUrl')?.textContent || 'ws://localhost:4000/ws';
            
            if (connected) {
                status.className = 'connected';
                status.innerHTML = 'Connected to server<div class="server-indicator">Server: ' + serverUrl + '</div>';
            } else {
                status.className = 'disconnected';
                status.innerHTML = 'Disconnected from server - Reconnecting in 3s...<div class="server-indicator">Server: ' + serverUrl + '</div>';
                
                // Auto-reconnect after 3 seconds with exponential backoff
                setTimeout(() => {
                    console.log('Attempting to reconnect...');
                    try {
                        window.location.reload();
                    } catch (e) {
                        console.error('Failed to reload:', e);
                        // Fallback: try again in 5 seconds
                        setTimeout(() => window.location.reload(), 5000);
                    }
                }, 3000);
            }
        };
        
        // Logarithmic scale conversion for particle count
        function sliderToParticleCount(sliderValue) {
            // Convert 0-100 slider to 1000-1000000 particles logarithmically
            const minLog = Math.log10(1000);    // log10(1000) = 3
            const maxLog = Math.log10(1000000); // log10(1000000) = 6
            const logValue = minLog + (sliderValue / 100) * (maxLog - minLog);
            return Math.round(Math.pow(10, logValue));
        }
        
        function particleCountToSlider(particleCount) {
            // Convert particle count back to 0-100 slider value
            const minLog = Math.log10(1000);
            const maxLog = Math.log10(1000000);
            const logValue = Math.log10(Math.max(1000, Math.min(1000000, particleCount)));
            return Math.round(((logValue - minLog) / (maxLog - minLog)) * 100);
        }
        
        // Debounced function for config updates
        function debouncedConfigUpdate(updateFn, delay = 200) {
            if (configUpdateTimeout) {
                clearTimeout(configUpdateTimeout);
            }
            configUpdateTimeout = setTimeout(() => {
                if (isConnected && client) {
                    try {
                        if (window.N_BODY_DEBUG) {
                            console.log('Executing debounced config update');
                        }
                        updateFn();
                    } catch (e) {
                        console.error('Config update failed:', e);
                    }
                } else if (window.N_BODY_DEBUG) {
                    console.log('Skipping config update - not connected or no client');
                }
            }, delay);
        }
        
        // Button state management
        function setButtonWorking(buttonId, working = true) {
            const button = document.getElementById(buttonId);
            if (working) {
                button.classList.add('working');
                button.disabled = true;
                button.dataset.originalText = button.textContent;
                if (buttonId === 'resetBtn') button.textContent = 'Resetting...';
                if (buttonId === 'pauseBtn') button.textContent = 'Working...';
            } else {
                button.classList.remove('working');
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                    delete button.dataset.originalText;
                }
            }
        }
        
        // Handle page visibility changes (shift-reload detection)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Page hidden - preparing for potential reload');
            } else {
                console.log('Page visible - checking connection');
                if (!isConnected && client) {
                    console.log('Page became visible but not connected - attempting reconnection');
                    setTimeout(() => window.location.reload(), 1000);
                }
            }
        });
        
        // Handle beforeunload to clean up connections
        window.addEventListener('beforeunload', () => {
            if (client && isConnected) {
                console.log('Page unloading - closing WebSocket');
                // Client WebSocket will be cleaned up automatically
            }
        });

        async function run() {
            try {
                await init();
                
                const loading = document.getElementById('loading');
                loading.classList.add('hidden');
                
                const canvas = document.getElementById('canvas');
                
                // Determine WebSocket URL from current page
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname || 'localhost';
                const port = window.location.port || '4000';
                const serverUrl = `${protocol}//${host}:${port}/ws`;
                
                document.getElementById('serverUrl').textContent = serverUrl;
                
                // Create client with error handling
                try {
                    client = new Client(canvas, serverUrl);
                    
                    // Start client (WebSocket handlers are set up internally)
                    client.start();
                    
                    // Initialize slider values based on config
                    const initialSliderValue = particleCountToSlider(3000); // Default from config
                    document.getElementById('particleCount').value = initialSliderValue;
                    document.getElementById('particleCountValue').textContent = '3,000';
                    
                    // Set other initial values
                    document.getElementById('timeStepValue').textContent = '0.010';
                    document.getElementById('visualFPSValue').textContent = '30';
                    document.getElementById('zoomValue').textContent = '1.0x';
                    document.getElementById('gravityValue').textContent = '1.0';
                } catch (e) {
                    console.error('Failed to create or start client:', e);
                    setTimeout(() => window.location.reload(), 3000);
                    return;
                }
            } catch (e) {
                console.error('Failed to initialize WASM:', e);
                document.getElementById('loading').textContent = 'Failed to load - Retrying in 3s...';
                setTimeout(() => window.location.reload(), 3000);
                return;
            }
            
            // Handle window resize
            window.addEventListener('resize', () => {
                client.resize();
            });
            
            // Arrow key camera controls
            window.addEventListener('keydown', (e) => {
                if (!client) return;
                
                const moveAmount = 0.5; // Movement amount per key press
                
                switch(e.code) {
                    case 'ArrowUp':
                        e.preventDefault();
                        client.move_camera(0, moveAmount);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        client.move_camera(0, -moveAmount);
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        client.move_camera(-moveAmount, 0);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        client.move_camera(moveAmount, 0);
                        break;
                }
            });
            
            // Control handlers with improved UX
            document.getElementById('particleCount').addEventListener('input', (e) => {
                const sliderValue = parseInt(e.target.value);
                const particleCount = sliderToParticleCount(sliderValue);
                document.getElementById('particleCountValue').textContent = particleCount.toLocaleString();
                
                if (window.N_BODY_DEBUG) {
                    console.log(`Particle count changed: slider=${sliderValue}, particles=${particleCount}`);
                }
                
                // Auto-restart simulation when particle count changes significantly
                debouncedConfigUpdate(() => {
                    if (window.N_BODY_DEBUG) {
                        console.log(`Sending particle count update: ${particleCount}`);
                    }
                    client.set_particle_count(particleCount);
                }, 400); // Moderate delay for particle count changes
            });
            
            document.getElementById('timeStep').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('timeStepValue').textContent = value.toFixed(3);
                
                debouncedConfigUpdate(() => {
                    client.set_time_step(value);
                });
            });
            
            document.getElementById('visualFPS').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                document.getElementById('visualFPSValue').textContent = value;
                
                debouncedConfigUpdate(() => {
                    client.set_visual_fps(value);
                }, 100); // Faster response for FPS changes
            });
            
            document.getElementById('zoom').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('zoomValue').textContent = value.toFixed(1) + 'x';
                
                // Zoom is immediate (no server communication needed)
                client.set_zoom_level(value);
            });
            
            document.getElementById('gravity').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('gravityValue').textContent = value.toFixed(1);
                
                debouncedConfigUpdate(() => {
                    client.set_gravity_strength(value);
                });
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                if (!isConnected || !client) {
                    console.warn('Cannot reset: not connected to server');
                    return;
                }
                
                try {
                    setButtonWorking('resetBtn', true);
                    client.reset();
                    
                    // Reset working state after a short delay
                    setTimeout(() => setButtonWorking('resetBtn', false), 1000);
                } catch (e) {
                    console.error('Reset failed:', e);
                    setButtonWorking('resetBtn', false);
                }
            });
            
            document.getElementById('pauseBtn').addEventListener('click', (e) => {
                if (!isConnected || !client) {
                    console.warn('Cannot pause/resume: not connected to server');
                    return;
                }
                
                try {
                    setButtonWorking('pauseBtn', true);
                    
                    if (isPaused) {
                        client.resume();
                        setTimeout(() => {
                            e.target.textContent = 'Pause';
                            e.target.classList.remove('paused');
                            setButtonWorking('pauseBtn', false);
                        }, 300);
                    } else {
                        client.pause();
                        setTimeout(() => {
                            e.target.textContent = 'Resume';
                            e.target.classList.add('paused');
                            setButtonWorking('pauseBtn', false);
                        }, 300);
                    }
                    isPaused = !isPaused;
                } catch (e) {
                    console.error('Pause/resume failed:', e);
                    setButtonWorking('pauseBtn', false);
                }
            });
            
            document.getElementById('resetCameraBtn').addEventListener('click', () => {
                if (!client) {
                    console.warn('Cannot reset camera: client not initialized');
                    return;
                }
                
                try {
                    client.reset_camera();
                    console.log('Camera reset to center');
                } catch (e) {
                    console.error('Camera reset failed:', e);
                }
            });
        }
        
        run();
    </script>
</body>
</html>